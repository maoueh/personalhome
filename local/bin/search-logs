#!/usr/bin/env ruby

TIMESTAMP_REGEX = /\[(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}[-+]\d{4})\]/

def main(arguments)
  regex = /#{arguments[0]}/mi
  files = arguments.drop(1)

  log_lines = []
  files.each do |file|
    log_lines += fetch_lines(regex, file)
  end

  log_lines = log_lines.sort!().each do |log_line|
    puts log_line[1]
  end
end

def fetch_lines(regex, file)
  lines = []
  File.open(file).each do |line|
    lines << line
  end

  extract_log_lines(regex, lines)
end

def extract_log_lines(regex, lines)
  return [] if lines.empty?

  lines = lines.drop_while { |line| !timestampted_line?(line) }

  accumulation = []
  results = []

  lines.each do |line|
    if timestampted_line?(line)
      add_log_line(regex, results, accumulation) if !accumulation.empty?
      accumulation = []
    end

    accumulation << line
  end

  add_log_line(regex, results, accumulation)
  results
end

def add_log_line(regex, results, accumulation)
  log_line = create_log_line(accumulation)

  results << log_line if log_line[1] =~ regex
end

def create_log_line(lines)
  timestamp = TIMESTAMP_REGEX.match(lines[0])[1]
  log_line = lines.join("")

  [timestamp, log_line]
end

def timestampted_line?(line)
  line =~ TIMESTAMP_REGEX
end

main(ARGV)

